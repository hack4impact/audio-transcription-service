package transcription

import (
	"encoding/json"
	"os"
	"testing"

	"bufio"     // mock
	mockos "os" // mock

	"github.com/gorilla/websocket" // mock

	"github.com/golang/mock/gomock"
	"github.com/stretchr/testify/assert"
)

func TestTranscribeWithIBM(t *testing.T) {
	assert := assert.New(t)
	ctrl := gomock.NewController(t)
	defer ctrl.Finish()

	// Setup the mock package
	websocket.MOCK().SetController(ctrl)
	mockos.MOCK().SetController(ctrl)
	bufio.MOCK().SetController(ctrl)

	mockWS := new(websocket.Conn)
	mockFile := new(mockos.File)
	mockReader := new(bufio.Reader)

	websocket.DefaultDialer.EXPECT().Dial(gomock.Any(), gomock.Any()).Return(mockWS, nil, nil).Times(1)
	mockWS.EXPECT().WriteJSON(gomock.Any()).MinTimes(1)
	mockos.EXPECT().Open("file.flac").Times(1).Return(mockFile, nil).Times(1)
	bufio.EXPECT().NewReader(mockFile).Return(mockReader).Times(1)
	mockReader.EXPECT().Read(gomock.Any()).Return(0, nil).Times(1)
	mockWS.EXPECT().WriteMessage(websocket.BinaryMessage, gomock.Any()).MinTimes(1)
	mockWS.EXPECT().ReadJSON(gomock.Any()).Do(func(res **IBMResult) {
		(*res).Results = []ibmResultField{
			ibmResultField{},
			ibmResultField{},
		}
	}).Times(1)
	mockWS.EXPECT().Close().Times(1) // could run many times

	_, err := TranscribeWithIBM("file.flac", "", "")
	assert.NoError(err)
}

func TestGetTranscript(t *testing.T) {
	assert := assert.New(t)

	res := new(IBMResult)
	file, _ := os.Open("test.json")
	json.NewDecoder(file).Decode(res)
	ts := GetTranscript(res)

	expectedTS := "in the mid sixties the airline industry had a problem it was in the plains the planes were awesome in fact the seven forty seven the first real jumbo jet had just been introduced there were more passengers at the airport than ever and that was the problem more passengers meant longer lines this was the era when you paid for your ticket right there at the airport that was sort of a slow cumbersome process this is Jerome struggles he worked for IBM at the time and remember it's fifty years ago so when you walk up to the counter and you give them your credit card your credit card is just just plastic rectangle it's got your name on it in some numbers so nice and elegant but that simplicity made it a hassle because you have to hand your credit card to the ticket agent and then you'd weights somebody dial the telephone because the bank asks for the clerk the clerk gas for the account number this all done manually and it is just as tedious as so the airlines they wanted something faster and they come to IBM and say what you got Spiegel's goes and assembles his team of PhD and they have to try and figure out how to take all of that information in that telephone call and put it on the card itself in a way that a machine could understand they tried bar codes they tried something with metal particles that I didn't really understand and the eventual solution which I personally like as a radio producer a strip of magnetic cassette tape our first cars are actually pieces of audio tape wrapped around the cardboard to simulate the bank card meaning that like you took apart and audio tape and stapled it to a piece of cardboard we just we just basically cut off a length of audiotape and scratch statement guard it was essentially how we did it they called it the mag stripe because it is a stripe of magnetic tape all the way across the back Spiegel's knew he had a winner but he needed to prove it before anybody else would take this leap entrusted right so he talks American Express into issuing these fancy new magstripe cards and then he needs a place to test so he gets American Airlines to set up a kiosk in Chicago o'hare airport and then they watch it rolled out very very well it was exceptionally mt successful effect people would come from one end of the airport walk all the way to the other end of the terminal just to use the machine because it was quicker than standing in line other airline saw this other banks others who they were like I want one of those give me a magnetic stripe on my cards give me that machine and a legend was born the credit card swipe it was fast it was convenient and it was also a gold plated invite to criminals everywhere to copy this card well welcome to planet money I'm Robert Smith here with our senior producer Alex Goldmark today on the show the history of the credit card is the history of this sort of battle every democratic card maker tries to put something on it to me the like audio strip criminal figures out how to crack it and take your money the war of convene versus security for decades there has been a more secure option than the magnetic strip it is that little square computer chip that is landing on your credit cards right now why did it take us so long to get it and why now that it's here is nobody using maybe because it's super slow it annoyed anyway today a quick history of what's in your pocket support for NPR and the following message come from personal capital the smart way to track and manage your net worth see all your financial accounts in one place and get free online investing software and money management tools you can even speak with a dedicated personal investment adviser join us today personal capital dot com slash money the magstripe that little piece of audiotape of that your credit cards it has been around for decades same as it ever was in fact you can take any car that your wallet that has a mag stripe and you can actually play it it's audiotape it is still audiotape or if we just took scissors cut out the magnetic stripe and ran it through one of the old tape machines here in the pn it sounds like aliens trying to make contact at the heart of our on our credit cards you know this little strip of audio tape I consider this the original sin of the credit card industry it was the first time they said all we want these things to be fast and convenient for everybody but since then this strip has cursed us because you know if you've ever made a cassette bootleg it is incredibly easy to copy audiotape so easy you can learn how to fake a credit card in about ninety seconds are you too all we have to do past is that then if you box for so because the magnetic strip was so easy to copy what credit card company started to do was to add things to your credit card for your credit card now I get one of these in the mail like every three months it every time I look at it they have added some sort of security feature to make up for the original sin of the magnetic stripe they added a little number a special security court on the back row in the hologram the hologram of a bird nobody ever looks at some of these cards have your picture on it and the newest thing to combat fraud that puter chip minus silver about the size of my thumbnail and this this is the thing that is supposed to save us all from fraud in theory for the history of this little chip we brought in Julian Longoria from W. NYCC originally did the story for the money talking podcast take Julia Roberts and you found out that this thing that seems super new and high tech has been around for decades decades and you track down the guy who invented it that's right he wrote the Patton in the seventies but he's actually dead now so I tracked down someone who worked with him in France and I called him up ml you know you know yeah mn so can you how can you go ahead and introduce yourself well I'm a genius usage is I'm going to answer the phone that way this is my glasses and he is an engineer I went to worse with PHP elsewhere who is a doctor and mark says the man who invented the chip was named Roland Moreno who was a colorful guy at a colorful time noises generation having summer marihuana the I think going on polluted city well are you thinking of hippies it is yes I knew we should never let hippies your credit cards not only was he if he was also a comedian and a freelance journalist and he liked to hang out at places like Motorola with the electrical engineers there and all the engineers would talk about this big problem France was having at the time credit card fraud we were trained to to make the security vice city essentially to avoid default stride there was a ridiculous inordinate amount of fraud in France at the time and the reason for this is that the French phone lines kinda sucked and phone lines are important because when you swipe a credit card what's happening behind the scenes is that the machine is calling over a phone line to the bank to get the okay to make sure that the card is legit but in France sometimes these calls wouldn't go through each because expensive so what the French store owners would do is they would wait until the very end of the day after taking credit cards all day long in they would make one call for all the purchases at the end of the day and you know not to be a criminal to figure out how you can take advantage of this now you get up early to make a fake card you show up at the store or buy something at nine o'clock in the morning Hermes bag and by the time they make the security phone call at the end of the day your god you're halfway to Marseilles and they can never catch so Roland Moreno are hit the inventor had a solution you thought you know we are using computer chips and computers they have this vast power to calculate and compute why not use a computer chip in a credit card transaction computer chip could make each purchase unique it would create a unique code and it would be virtually impossible to copy that chip so the card reader in the store would say yes that's a real card without ever having to make a phone call but this is the nineteen seventies so putting a computer chip in anything seems very expensive and complicated and far fetched the idea of a coming from stupid French was not definitively say use one of the problems was where with the chip go seemed hard to put it on a card rate like cards are bendy you take it in and out of your pocket the static electricity is going to mess with the computer and chips back in the old days are larger than they are now right so Roland thought why not ditch the card altogether and put it on a ring we don't know if Rolande was a big jewelry owner but you can use one of his ribs actually my ring actually stole one of my rings and put a chip on it and especially I didn't never I was wondered what happened to that ring that is rolling around us ex wife Stephanie stolen Moreno and she says being married to an inventor was hard he was a fascinating guy but not easy to live with the of people like that usually aren't so the ring never quite caught on thank you but we're gonna go so eventually Moreno and engineers figured out how to put a chip on the face of a credit card but even then banks and stores didn't seem interested well for many years you know we weren't earning ascent and the whole all was sure that we just weren't that we're going to be poor all our lives but Roland was saved by this one thing the fraud in France kept rising and rising and it became harder and harder for the banks to ignore Roland he just kept phoning people and knocking on doors until it finally happened roll-on runners chip was eventually adopted as the solution for fraud in France and French criminal said mon do you have outsmarted us and they gave up no the fraud actually migrated course fraud likes to find a new home in it it meant for the UK that is all over Manahan he used to work at MasterCard as they planned for this big switch over to chips and he says fraud always moves to the weakest link in this case French fraud moved next door I guess we should say the channel counterfeiter started to make fake credit cards in the UK that is until the Brits decided they would switch the chip and then the fraud kept on moving criminal did the grand tour of Europe by the early two thousands all of Europe is like alright fine fine were put the chips in the cards so this stupid French idea becomes the universal solution to fraud they called it EMB short for euro pay MasterCard and visa the three companies that decided to make it the standard but of course that part looks for that the next week just link which you know it became North America are some parts of Latin America or some parts of Asia Pacific all of the major economies eventually adopt except us except for the United States of America this cutting edge French technology the nineteen seventies takes forty years to get to our shores and for the final part about why this took America's so long to copy the French we're gonna go back to our own senior producer Alex Goldmark thank you so much Julia thank you socks was good enough for the French why wasn't good enough for us we are different Robert we aren't everyone else America is bigger than all of the other markets there's just more banks in more stores way more people that all have to agree on switching at the same time because this is the kind of thing that you can't do by yourself I mean obviously like if you just put out a credit card with a chip on it and there's no readers that won't work you don't put the readers in your store before anyone put the chip on the card everyone has to do it at the same time it's what we refer to as a collective action problem everybody could see and visualize the world they want to get to where they all work together to stop fraud but nobody would take the first step it really is a critical mass sort of game where you have to get everybody involved and and working towards the same common goal and it's not just coordination right so if you go first and put a chip on your card here in America and you do it like Europe does it then you also have to add in a pinafore digit number that you remember and so then that's a disincentive because I have four credit cards my wallet and I'm sure as hell I can use the one that requires me to stick it into a machine put a code weenies easy one and so this is the type of situation where often the way you solve it is you have some central power maybe a government regulator come in and say everybody you've got to do acts by a certain date but another way collective action problems are solved is if the largest player in the market makes the first move and in this case there was a large player the visa corporation in August two that's eleven visa announced this little change to its contracts they gave a warning they said in the future whoever doesn't upgrade to a chip they will have to eat the cost of the fraud so if there's a store that doesn't accept the chip and then there is a fake credit card use there than the store has to pay but the bank if they don't put the chip on their card and one of their accounts has fraud the bank has to pay whoever is the weak link now has to pay the tab for fraud unless you put some sort of sign in line in the sand that says you know you will bear financial responsibility if you have an operator to the more secure technology than people will sit there forever and say I don't have a business case it was the new seven forty seven jumbo jet in the room it's a bit of a carrot it's a bit of a stick problem into depending on depending on which side of Iran visas gambit works MasterCard and American Express follow the banks a gag again will do this chip thing and then five years later I get a card in the mail and I have to say like I'm kind of excited at first because it looks really high tech it's a chip every time a chip goes into something I own that thing gets better and then all the sudden I go to use this chip card and it takes for after so I brought this up with however many handy cheerleader for the chip he said it's not actually that slow I don't know can I timed how long it is can I just walk you through it it's like yes absolutely okay so I'm I'm at the register I take out my card this is this is real time right now what we're doing here I take out my card %HESITATION they say Hey cash or credit I wanna take credit here's my card dipping my card now yep and they're now I get to take it out that's a long time what's going on there but I'm trying to sense is it five seconds versus the half second it takes to swipe something like that yet about six seconds for less than one second you know the the so the card remains in the reader for that duration because it's actually getting communicate from the bank to say I've authorized this and now I'm going to let you know that you are communicating with your valid bank so there's a two way communication so the security goes up but tear point that the time goes up as well and after I talked with Oliver offended at some places it takes up to fifteen seconds you know how long that is here let's do that fifteen seconds that was good caretaker but I just don't think that I got to do with my card all the time I could not take the fifteen seconds of my life and I know it seems petty to be griping about fifteen seconds because it's it is also on the other hand just fifteen seconds but like you know you can do in fifteen seconds you can use a math right take it at five seconds below average five seconds times the two hundred million credit card swipe there are every day and you know how much time that is that is thirty two years of human life spent staring across the counter and the clerk that wants you to just take your car to go away it does feel like thirty two years but on the other hand think about how much harder it is to copy a credit card now we can't do with a boom box but eventually like someone's going to crack the chip though right that happened a long time ago because the chip started in Europe along time ago cannot so they've already crack the chip and then six months from now a year from now they've added something else to my card they've put another thing a fingerprint scan a retinal something or other yeah probably in it seems to me that that at some point you have to say fraud is always going to exist I mean we don't frisk everyone leaves a store just because shop lifters exist at some point you just have to say let's stop this escalation of the credit card I know you're joking a little bit there but the next phase of the cycle it's already starting to repeat itself fraud is already migrating to the next place which is the internet where you don't need a physical car journey to copy anything just at the numbers and so the credit card companies they already have their next step in this postcard world and it is your phone apple pay Google wallet master card it already works and you can just tap and go so just make this clear we waited for years for the chip and it's already come out slow to come slow to use I believe and criminals criminals that sound we play the top not actually a credit card was our metrocard let us know what you thought of today's episode effect let everyone know what you thought of today's episode you can find us on Twitter at planet money or on Facebook and we've been having a tough time trying to find out exactly how long it takes to dip a credit card is it six seconds fifteen seconds we want your help in figuring it out the next time you're going to use your chip credit card take out your stopwatch and tiny we put up a form on the episode page at our website please go and tell us how long it took you to death but they say to Julie along Korea and WNYC's pocket money talking it easy weekly look at what's going on in the world of business check it out and special thanks to Ralph dangle Meyer and Bob hunt they both helped us out with our reporting on this episode just Jiang produced it I'm Alex Goldmark and I'm Robert Smith explicit "
	assert.Equal(expectedTS, ts)
}
